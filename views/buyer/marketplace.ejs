<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Marketplace - AgriTech</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <style>
    :root {
      --primary-green: #28a745;
      --dark-green: #218838;
    }
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #f8f9fa;
    }
    .navbar {
      background: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .navbar-brand {
      font-weight: 700;
      color: var(--primary-green) !important;
    }
    .btn-success {
      background-color: var(--primary-green);
      border-color: var(--primary-green);
    }
    .btn-success:hover {
      background-color: var(--dark-green);
      border-color: var(--dark-green);
    }
    .product-card {
      transition: transform 0.3s, box-shadow 0.3s;
      border: none;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .product-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    }
    .category-badge {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(40, 167, 69, 0.9);
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: capitalize;
    }
    .product-image {
      height: 200px;
      object-fit: cover;
    }
    .category-btn {
      transition: all 0.3s;
    }
    .category-btn.active {
      background-color: var(--primary-green);
      color: white;
      border-color: var(--primary-green);
    }
    #cartBadge {
      position: absolute;
      top: -8px;
      right: -8px;
      background: red;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-light mb-4">
    <div class="container-fluid">
      <a class="navbar-brand" href="/buyer/marketplace">
        <i class="fas fa-seedling me-2"></i>AgriTech
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link active" href="/buyer/marketplace">Marketplace</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/buyer/dashboard">My Purchases</a>
          </li>
          <li class="nav-item">
            <a class="nav-link position-relative" href="/buyer/cart">
              <i class="fas fa-shopping-cart"></i> Cart
              <span id="cartBadge" class="badge bg-danger" style="display: none;">0</span>
            </a>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="languageDropdown" role="button" data-bs-toggle="dropdown">
              <i class="fas fa-language"></i> Language
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="#">English</a></li>
              <li><a class="dropdown-item" href="#">हिंदी</a></li>
            </ul>
          </li>
          <li class="nav-item">
            <form action="/logout" method="POST" class="d-inline">
              <button type="submit" class="btn btn-outline-danger btn-sm">Logout</button>
            </form>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container-fluid">
    <!-- Flash Messages -->
    <div id="flashMessages"></div>

    <!-- Header Section -->
    <div class="row mb-4">
      <div class="col-md-6">
        <h2 class="mb-1">Marketplace</h2>
        <p class="text-muted">Fresh produce directly from farmers</p>
      </div>
      <div class="col-md-6">
        <div class="input-group mb-3">
          <span class="input-group-text"><i class="fas fa-search"></i></span>
          <input type="text" class="form-control" id="searchInput" placeholder="Search products by name or description...">
        </div>
        <select class="form-select" id="sortSelect">
          <option value="newest">Sort: Newest First</option>
          <option value="price_asc">Sort: Price Low to High</option>
          <option value="price_desc">Sort: Price High to Low</option>
        </select>
      </div>
    </div>

    <!-- Category Filters -->
    <div class="mb-4">
      <div class="btn-group flex-wrap" role="group" id="categoryFilters">
        <button type="button" class="btn btn-outline-success category-btn active" data-category="All">All Products</button>
        <button type="button" class="btn btn-outline-success category-btn" data-category="fruits">
          <i class="fas fa-apple-alt me-1"></i>Fruits
        </button>
        <button type="button" class="btn btn-outline-success category-btn" data-category="vegetables">
          <i class="fas fa-carrot me-1"></i>Vegetables
        </button>
        <button type="button" class="btn btn-outline-success category-btn" data-category="dairy">
          <i class="fas fa-cheese me-1"></i>Dairy
        </button>
        <button type="button" class="btn btn-outline-success category-btn" data-category="grains">
          <i class="fas fa-seedling me-1"></i>Grains
        </button>
        <button type="button" class="btn btn-outline-success category-btn" data-category="spices">
          <i class="fas fa-pepper-hot me-1"></i>Spices
        </button>
        <button type="button" class="btn btn-outline-success category-btn" data-category="organic">
          <i class="fas fa-leaf me-1"></i>Organic
        </button>
      </div>
    </div>

    <!-- Products Grid -->
    <div id="productsGrid" class="row g-4">
      <% products.forEach(p => { %>
        <div class="col-md-6 col-lg-4 product-item" data-category="<%= p.category %>" data-name="<%= p.name.toLowerCase() %>" data-description="<%= p.description.toLowerCase() %>">
          <div class="card product-card h-100">
            <div class="position-relative">
              <img src="<%= p.image || p.imagePath || 'https://images.unsplash.com/photo-1501004318641-b39e6451bec6?q=80&w=1200&auto=format&fit=crop' %>" 
                   class="card-img-top product-image" alt="<%= p.name %>">
              <span class="category-badge"><%= p.category %></span>
              <% if (p.isOrganic) { %>
                <span class="badge bg-success position-absolute top-0 end-0 m-2">
                  <i class="fas fa-leaf me-1"></i>Organic
                </span>
              <% } %>
            </div>
            <div class="card-body">
              <h5 class="card-title"><%= p.name %></h5>
              <p class="card-text text-muted small"><%= p.description %></p>
              <div class="d-flex justify-content-between align-items-center mb-3">
                <span class="h5 text-success mb-0">₹<%= Number(p.price).toFixed(2) %></span>
                <small class="text-muted">By <%= p.farmerId?.name || 'Farmer' %></small>
              </div>
              <div class="d-grid gap-2">
                <button class="btn btn-success buyBtn" data-product-id="<%= p._id %>">
                  <i class="fas fa-shopping-bag me-2"></i>Buy Now
                </button>
                <button class="btn btn-outline-success addToCartBtn" data-product-id="<%= p._id %>" data-product-name="<%= p.name %>" data-product-price="<%= p.price %>" data-product-image="<%= p.image || p.imagePath || '' %>">
                  <i class="fas fa-cart-plus me-2"></i>Add to Cart
                </button>
              </div>
            </div>
          </div>
        </div>
      <% }) %>
    </div>

    <!-- Empty State -->
    <div id="emptyState" class="text-center py-5" style="display: none;">
      <i class="fas fa-search fa-3x text-muted mb-3"></i>
      <p class="text-muted">No products found. Try a different search or category.</p>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Cart management
    function getCart() {
      const cart = localStorage.getItem('cart');
      return cart ? JSON.parse(cart) : [];
    }

    function saveCart(cart) {
      localStorage.setItem('cart', JSON.stringify(cart));
      updateCartBadge();
    }

    function updateCartBadge() {
      const cart = getCart();
      const badge = document.getElementById('cartBadge');
      if (cart.length > 0) {
        badge.textContent = cart.length;
        badge.style.display = 'flex';
      } else {
        badge.style.display = 'none';
      }
    }

    function addToCart(product) {
      const cart = getCart();
      const existingItem = cart.find(item => item.id === product.id);
      if (existingItem) {
        existingItem.quantity += 1;
      } else {
        cart.push({ ...product, quantity: 1 });
      }
      saveCart(cart);
      showFlashMessage('Product added to cart!', 'success');
    }

    // Initialize cart badge
    updateCartBadge();

    // Add to Cart functionality
    document.querySelectorAll('.addToCartBtn').forEach(btn => {
      btn.addEventListener('click', function() {
        const productId = this.getAttribute('data-product-id');
        const productName = this.getAttribute('data-product-name');
        const productPrice = this.getAttribute('data-product-price');
        const productImage = this.getAttribute('data-product-image');
        
        addToCart({
          id: productId,
          name: productName,
          price: parseFloat(productPrice),
          image: productImage
        });
      });
    });

    // Buy Now functionality
    document.querySelectorAll('.buyBtn').forEach(btn => {
      btn.addEventListener('click', async function() {
        const productId = this.getAttribute('data-product-id');
        try {
          const res = await fetch('/payment/create-order', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ productId })
          });
          const data = await res.json();
          
          if (data.error) {
            showFlashMessage(data.error, 'danger');
            return;
          }

          const options = {
            key: data.key,
            amount: data.amount,
            currency: data.currency,
            name: 'AgriTech',
            description: 'Order Payment',
            order_id: data.orderId,
            handler: async function (response) {
              const verifyRes = await fetch('/payment/verify', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(response)
              });
              const verifyData = await verifyRes.json();
              if (verifyData.success) {
                window.location.href = '/buyer/dashboard';
              }
            }
          };
          new Razorpay(options).open();
        } catch (error) {
          console.error('Error:', error);
          showFlashMessage('Error processing payment', 'danger');
        }
      });
    });

    // Category filter
    let currentCategory = 'All';
    document.querySelectorAll('.category-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        currentCategory = this.getAttribute('data-category');
        filterProducts();
      });
    });

    // Search functionality
    let searchQuery = '';
    document.getElementById('searchInput').addEventListener('input', function() {
      searchQuery = this.value.toLowerCase();
      filterProducts();
    });

    // Sort functionality
    document.getElementById('sortSelect').addEventListener('change', function() {
      sortProducts(this.value);
    });

    // Filter and search products
    function filterProducts() {
      const products = document.querySelectorAll('.product-item');
      let visibleCount = 0;

      products.forEach(product => {
        const category = product.getAttribute('data-category');
        const name = product.getAttribute('data-name');
        const description = product.getAttribute('data-description');
        
        const matchesCategory = currentCategory === 'All' || category === currentCategory.toLowerCase();
        const matchesSearch = !searchQuery || name.includes(searchQuery) || description.includes(searchQuery);
        
        if (matchesCategory && matchesSearch) {
          product.style.display = 'block';
          visibleCount++;
        } else {
          product.style.display = 'none';
        }
      });

      document.getElementById('emptyState').style.display = visibleCount === 0 ? 'block' : 'none';
    }

    // Sort products
    function sortProducts(sortBy) {
      const grid = document.getElementById('productsGrid');
      const products = Array.from(grid.querySelectorAll('.product-item'));

      products.sort((a, b) => {
        if (sortBy === 'price_asc') {
          return parseFloat(a.querySelector('.text-success').textContent.replace('₹', '')) - 
                 parseFloat(b.querySelector('.text-success').textContent.replace('₹', ''));
        } else if (sortBy === 'price_desc') {
          return parseFloat(b.querySelector('.text-success').textContent.replace('₹', '')) - 
                 parseFloat(a.querySelector('.text-success').textContent.replace('₹', ''));
        }
        return 0;
      });

      products.forEach(product => grid.appendChild(product));
    }

    // Flash message function
    function showFlashMessage(message, type) {
      const flashDiv = document.getElementById('flashMessages');
      const alert = document.createElement('div');
      alert.className = `alert alert-${type} alert-dismissible fade show`;
      alert.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      flashDiv.appendChild(alert);
      setTimeout(() => alert.remove(), 3000);
    }
  </script>
</body>
</html>
